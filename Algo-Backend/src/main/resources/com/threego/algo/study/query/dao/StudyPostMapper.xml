<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.threego.algo.study.query.dao.StudyPostMapper">
    <!-- 스터디 게시물 목록 조회용 매핑 -->
    <resultMap id="StudyPostMap" type="com.threego.algo.study.query.dto.StudyPostDTO">
        <id property="id" column="POST_ID"/>
        <result property="studyId" column="STUDY_ID"/>
        <result property="memberId" column="MEMBER_ID"/>
        <result property="memberNickname" column="MEMBER_NICKNAME"/>
        <result property="title" column="POST_TITLE"/>
        <result property="content" column="POST_CONTENT"/>
        <result property="commentCount" column="COMMENT_COUNT"/>
        <result property="createdAt" column="POST_CREATED_AT"/>
        <result property="updatedAt" column="POST_UPDATED_AT"/>
        <result property="visibility" column="POST_VISIBILITY"/>
    </resultMap>

    <!-- 스터디 게시물 상세 조회용 매핑 -->
    <resultMap id="StudyPostDetailMap" type="com.threego.algo.study.query.dto.StudyPostDetailDTO">
        <id property="id" column="POST_ID"/>
        <result property="studyId" column="STUDY_ID"/>
        <result property="memberId" column="MEMBER_ID"/>
        <result property="memberNickname" column="MEMBER_NICKNAME"/>
        <result property="title" column="POST_TITLE"/>
        <result property="content" column="POST_CONTENT"/>
        <result property="commentCount" column="COMMENT_COUNT"/>
        <result property="createdAt" column="POST_CREATED_AT"/>
        <result property="updatedAt" column="POST_UPDATED_AT"/>
        <result property="visibility" column="POST_VISIBILITY"/>
        <collection property="images" ofType="com.threego.algo.study.query.dto.StudyPostDetailDTO$PostImageInfo">
            <id property="imageId" column="IMAGE_ID"/>
            <result property="imageUrl" column="IMAGE_URL"/>
            <result property="createdAt" column="IMAGE_CREATED_AT"/>
        </collection>
    </resultMap>

    <!-- 스터디 댓글 조회용 매핑 -->
    <resultMap id="StudyCommentMap" type="com.threego.algo.study.query.dto.StudyCommentDTO">
        <id property="id" column="COMMENT_ID"/>
        <result property="postId" column="POST_ID"/>
        <result property="memberId" column="MEMBER_ID"/>
        <result property="memberNickname" column="MEMBER_NICKNAME"/>
        <result property="parentId" column="PARENT_ID"/>
        <result property="content" column="COMMENT_CONTENT"/>
        <result property="createdAt" column="COMMENT_CREATED_AT"/>
        <result property="updatedAt" column="COMMENT_UPDATED_AT"/>
        <result property="visibility" column="COMMENT_VISIBILITY"/>
    </resultMap>

    <!-- 스터디 게시물 목록 조회 -->
    <select id="selectAllStudyPosts"
            parameterType ="com.threego.algo.study.query.dto.StudyPostSearchDTO"
            resultMap="StudyPostMap">
        <!-- offset 자동 계산 -->
        <if test="page != null and size != null">
            <bind name="offset" value="page * size"/>
        </if>

        SELECT
               A.ID           AS POST_ID
             , A.STUDY_ID     AS STUDY_ID
             , A.MEMBER_ID    AS MEMBER_ID
             , C.NICKNAME     AS MEMBER_NICKNAME
             , A.TITLE        AS POST_TITLE
             , A.CONTENT      AS POST_CONTENT
             , A.COMMENT_COUNT AS COMMENT_COUNT
             , A.CREATED_AT   AS POST_CREATED_AT
             , A.UPDATED_AT   AS POST_UPDATED_AT
             , A.VISIBILITY   AS POST_VISIBILITY
          FROM STUDY_POST A
          JOIN STUDY_MEMBER B ON A.MEMBER_ID = B.MEMBER_ID
          JOIN MEMBER C       ON B.MEMBER_ID = C.ID
         WHERE A.STUDY_ID = #{studyId}
           AND A.VISIBILITY = 'Y'
           AND B.ROLE != 'NOT_MEMBER'
         ORDER BY A.CREATED_AT DESC
        <if test="size != null and size > 0">
            LIMIT #{size}
            <if test="offset != null and offset >= 0">
                OFFSET #{offset}
            </if>
        </if>
    </select>

    <!-- 스터디 게시물 상세 조회 -->
    <select id="selectStudyPostDetail" parameterType="int" resultMap="StudyPostDetailMap">
        SELECT
               A.ID           AS POST_ID
             , A.STUDY_ID     AS STUDY_ID
             , A.MEMBER_ID    AS MEMBER_ID
             , C.NICKNAME     AS MEMBER_NICKNAME
             , A.TITLE        AS POST_TITLE
             , A.CONTENT      AS POST_CONTENT
             , A.COMMENT_COUNT AS COMMENT_COUNT
             , A.CREATED_AT   AS POST_CREATED_AT
             , A.UPDATED_AT   AS POST_UPDATED_AT
             , A.VISIBILITY   AS POST_VISIBILITY
             , D.ID           AS IMAGE_ID
             , D.IMAGE_URL    AS IMAGE_URL
          FROM STUDY_POST A
          JOIN STUDY_MEMBER B    ON A.MEMBER_ID = B.ID
          JOIN MEMBER C          ON B.MEMBER_ID = C.ID
          LEFT JOIN STUDY_POST_IMAGE D ON A.ID = D.POST_ID
         WHERE A.ID = #{postId}
           AND A.VISIBILITY = 'Y'
           AND B.ROLE != 'NOT_MEMBER'
         ORDER BY D.ID ASC
    </select>

    <!-- 스터디 게시물 댓글 조회 -->
    <select id="selectStudyPostComments" parameterType="int" resultMap="StudyCommentMap">
        SELECT
               A.ID           AS COMMENT_ID
             , A.POST_ID      AS POST_ID
             , A.MEMBER_ID    AS MEMBER_ID
             , C.NICKNAME     AS MEMBER_NICKNAME
             , A.PARENT_ID    AS PARENT_ID
             , A.CONTENT      AS COMMENT_CONTENT
             , A.CREATED_AT   AS COMMENT_CREATED_AT
             , A.UPDATED_AT   AS COMMENT_UPDATED_AT
             , A.VISIBILITY   AS COMMENT_VISIBILITY
          FROM STUDY_COMMENT A
          JOIN STUDY_MEMBER B ON A.MEMBER_ID = B.MEMBER_ID
          JOIN MEMBER C       ON B.MEMBER_ID = C.ID
         WHERE A.POST_ID = #{postId}
           AND A.VISIBILITY = 'Y'
           AND B.ROLE != 'NOT_MEMBER'
         ORDER BY A.PARENT_ID ASC, A.CREATED_AT ASC
    </select>

    <!-- 숨김 처리된 스터디 게시물 목록 조회 -->
    <select id="selectAllHiddenStudyPosts" parameterType="com.threego.algo.study.query.dto.StudyPostSearchDTO" resultMap="StudyPostMap">
        <!-- offset 자동 계산 -->
        <if test="page != null and size != null">
            <bind name="offset" value="page * size"/>
        </if>

        SELECT
               A.ID           AS POST_ID
             , A.STUDY_ID     AS STUDY_ID
             , A.MEMBER_ID    AS MEMBER_ID
             , C.NICKNAME     AS MEMBER_NICKNAME
             , A.TITLE        AS POST_TITLE
             , A.CONTENT      AS POST_CONTENT
             , A.COMMENT_COUNT AS COMMENT_COUNT
             , A.CREATED_AT   AS POST_CREATED_AT
             , A.UPDATED_AT   AS POST_UPDATED_AT
             , A.VISIBILITY   AS POST_VISIBILITY
          FROM STUDY_POST A
          JOIN STUDY_MEMBER B ON A.MEMBER_ID = B.MEMBER_ID
          JOIN MEMBER C       ON B.MEMBER_ID = C.ID
         WHERE A.VISIBILITY = 'N'
         ORDER BY A.CREATED_AT DESC
        <if test="size != null and size > 0">
            LIMIT #{size}
            <if test="offset != null and offset >= 0">
                OFFSET #{offset}
            </if>
        </if>
    </select>

    <!-- 숨김 처리된 스터디 게시물 상세 조회 -->
    <select id="selectHiddenStudyPostDetail" parameterType="int" resultMap="StudyPostDetailMap">
        SELECT
               A.ID           AS POST_ID
             , A.STUDY_ID     AS STUDY_ID
             , A.MEMBER_ID    AS MEMBER_ID
             , C.NICKNAME     AS MEMBER_NICKNAME
             , A.TITLE        AS POST_TITLE
             , A.CONTENT      AS POST_CONTENT
             , A.COMMENT_COUNT AS COMMENT_COUNT
             , A.CREATED_AT   AS POST_CREATED_AT
             , A.UPDATED_AT   AS POST_UPDATED_AT
             , A.VISIBILITY   AS POST_VISIBILITY
             , D.ID           AS IMAGE_ID
             , D.IMAGE_URL    AS IMAGE_URL
          FROM STUDY_POST A
          JOIN STUDY_MEMBER B    ON A.MEMBER_ID = B.ID
          JOIN MEMBER C          ON B.MEMBER_ID = C.ID
          LEFT JOIN STUDY_POST_IMAGE D ON A.ID = D.POST_ID
         WHERE A.ID = #{postId}
           AND A.VISIBILITY = 'N'
         ORDER BY D.ID ASC
    </select>

    <!-- 숨김 처리된 스터디 댓글 목록 조회 -->
    <select id="selectAllHiddenStudyComments" parameterType="com.threego.algo.study.query.dto.StudyPostSearchDTO" resultMap="StudyCommentMap">
        <!-- offset 자동 계산 -->
        <if test="page != null and size != null">
            <bind name="offset" value="page * size"/>
        </if>

        SELECT
               A.ID           AS COMMENT_ID
             , A.POST_ID      AS POST_ID
             , A.MEMBER_ID    AS MEMBER_ID
             , C.NICKNAME     AS MEMBER_NICKNAME
             , A.PARENT_ID    AS PARENT_ID
             , A.CONTENT      AS COMMENT_CONTENT
             , A.CREATED_AT   AS COMMENT_CREATED_AT
             , A.UPDATED_AT   AS COMMENT_UPDATED_AT
             , A.VISIBILITY   AS COMMENT_VISIBILITY
          FROM STUDY_COMMENT A
          JOIN STUDY_MEMBER B ON A.MEMBER_ID = B.MEMBER_ID
          JOIN MEMBER C       ON B.MEMBER_ID = C.ID
         WHERE A.VISIBILITY = 'N'
         ORDER BY A.CREATED_AT DESC
        <if test="size != null and size > 0">
            LIMIT #{size}
            <if test="offset != null and offset >= 0">
                OFFSET #{offset}
            </if>
        </if>
    </select>
</mapper>