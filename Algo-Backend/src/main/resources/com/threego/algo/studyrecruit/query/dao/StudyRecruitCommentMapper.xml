<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.threego.algo.studyrecruit.query.dao.StudyRecruitCommentMapper">

    <!-- 댓글 조회용 결과 매핑 -->
    <resultMap id="StudyRecruitCommentMap" type="com.threego.algo.studyrecruit.query.dto.StudyRecruitCommentDTO">
        <id property="id" column="COMMENT_ID"/>
        <result property="postId" column="POST_ID"/>
        <result property="parentId" column="PARENT_ID"/>
        <result property="content" column="COMMENT_CONTENT"/>
        <result property="memberId" column="MEMBER_ID"/>
        <result property="memberNickname" column="MEMBER_NICKNAME"/>
        <result property="rankName" column="RANK_NAME"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="updatedAt" column="UPDATED_AT"/>
    </resultMap>

    <!-- 스터디 모집글 댓글 조회 -->
    <select id="selectStudyRecruitComments"
            parameterType="integer"
            resultMap="StudyRecruitCommentMap">
        SELECT
               A.ID AS COMMENT_ID
             , A.POST_ID AS POST_ID
             , A.PARENT_ID AS PARENT_ID
             , A.CONTENT AS COMMENT_CONTENT
             , A.MEMBER_ID AS MEMBER_ID
             , B.NICKNAME AS MEMBER_NICKNAME
             , C.NAME AS RANK_NAME
             , A.CREATED_AT AS CREATED_AT
             , A.UPDATED_AT AS UPDATED_AT
          FROM STUDY_RECRUIT_COMMENT A
                JOIN MEMBER B ON A.MEMBER_ID = B.ID
                JOIN MEMBER_RANK C ON B.RANK_ID = C.ID
         WHERE A.POST_ID = #{postId}
           AND A.VISIBILITY = 'Y'
         ORDER BY A.PARENT_ID ASC, A.ID ASC
    </select>

    <!-- 관리자용 - 전체 숨김 처리 댓글 목록 조회  -->
    <select id="selectAllStudyRecruitCommentsIncludeHidden"
            resultMap="StudyRecruitCommentMap">
        SELECT
               A.ID AS COMMENT_ID
             , A.POST_ID AS POST_ID
             , A.PARENT_ID AS PARENT_ID
             , A.CONTENT AS COMMENT_CONTENT
             , B.NICKNAME AS MEMBER_NICKNAME
             , C.NAME AS RANK_NAME
             , A.CREATED_AT AS CREATED_AT
             , A.UPDATED_AT AS UPDATED_AT
          FROM STUDY_RECRUIT_COMMENT A
          JOIN MEMBER B ON A.MEMBER_ID = B.ID
          JOIN MEMBER_RANK C ON B.RANK_ID = C.ID
           AND A.VISIBILITY = 'N'
         ORDER BY A.ID DESC
        <if test="size != null and size > 0">
            LIMIT #{size}
            <if test="offset != null and offset >= 0">
                OFFSET #{offset}
            </if>
        </if>
    </select>

    <!-- 관리자용 - 숨김 처리된 게시물의 댓글 조회 -->
    <select id="selectStudyRecruitCommentsIncludeHidden"
            parameterType="integer"
            resultMap="StudyRecruitCommentMap">
        SELECT
               A.ID AS COMMENT_ID
             , A.POST_ID AS POST_ID
             , A.PARENT_ID AS PARENT_ID
             , A.CONTENT AS COMMENT_CONTENT
             , B.NICKNAME AS MEMBER_NICKNAME
             , C.NAME AS RANK_NAME
             , A.CREATED_AT AS CREATED_AT
             , A.UPDATED_AT AS UPDATED_AT
          FROM STUDY_RECRUIT_COMMENT A
          JOIN MEMBER B ON A.MEMBER_ID = B.ID
          JOIN MEMBER_RANK C ON B.RANK_ID = C.ID
         WHERE A.POST_ID = #{postId}
         ORDER BY A.PARENT_ID ASC, A.ID ASC
    </select>

</mapper>